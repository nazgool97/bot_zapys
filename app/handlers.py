import datetime
# –Ø–∫—â–æ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É "Import 'telebot' could –Ω–µ be resolved", –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞–∫–µ—Ç:
# pip install pyTelegramBotAPI
try:
    from telebot import types
except ImportError:
    raise ImportError("–ú–æ–¥—É–ª—å 'pyTelegramBotAPI' –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —á–µ—Ä–µ–∑ 'pip install pyTelegramBotAPI'.")
# –Ø–∫—â–æ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É "Import 'ApiTelegramException' could not be resolved", –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞–∫–µ—Ç:
# pip install pyTelegramBotAPI
try:
    from telebot.apihelper import ApiTelegramException
except ImportError:
    raise ImportError("–ú–æ–¥—É–ª—å 'pyTelegramBotAPI' –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∞–±–æ –≤–µ—Ä—Å—ñ—è –∑–∞—Å—Ç–∞—Ä—ñ–ª–∞. –û–Ω–æ–≤—ñ—Ç—å —á–µ—Ä–µ–∑ 'pip install --upgrade pyTelegramBotAPI'.")
import io
import csv
from app.db import config, ADMIN_ID, MASTERS
# –Ø–∫—â–æ –±–∞—á–∏—Ç–µ –ø–æ–º–∏–ª–∫—É "Import 'telebot' could –Ω–µ be resolved", –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –ø–∞–∫–µ—Ç:
# pip install pyTelegramBotAPI
try:
    import telebot
except ImportError:
    raise ImportError("–ú–æ–¥—É–ª—å 'pyTelegramBotAPI' –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —á–µ—Ä–µ–∑ 'pip install pyTelegramBotAPI'.")
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')

from app.db import get_user_records, get_record, delete_record, user_service_count, get_all_records, get_today_records, save_record
from app.keyboards import services_kb, masters_kb, days_kb, time_kb
from app.utils import offer_waitlist, MONTH_NAMES, notify_waitlist, confirm_kb

user_states = {}  # –ú–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ –≤ bot.py –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ

def register_handlers(bot):
    @bot.message_handler(commands=['start', 'menu'])
    def start(message):
        bot.send_message(message.chat.id, config['messages'].get('welcome', "–ü—Ä–∏–≤—ñ—Ç! –û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É:"), reply_markup=services_kb())

    @bot.message_handler(commands=['my'])
    def my_records(message):
        send_my_records(message.chat.id, message.from_user.id)

    def send_my_records(chat_id, user_id, edit_message_id=None):
        try:
            user_records = get_user_records(user_id)
            if not user_records:
                text = config['messages'].get('no_records', "–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤.")
                if edit_message_id:
                    bot.edit_message_text(text, chat_id, edit_message_id)
                else:
                    bot.send_message(chat_id, text)
                return
            text = "üìã –í–∞—à—ñ –∑–∞–ø–∏—Å—ñ:"
            kb = types.InlineKeyboardMarkup()
            for rec in user_records:
                service, master, y, m, d, t = rec.split("|")
                record = get_record(rec)
                name = record['name'] if record and 'name' in record else ''
                label = f"{service} ({master}) {d}.{m}.{y} –æ {t} ({name})"
                kb.add(types.InlineKeyboardButton(f"‚ùå –í—ñ–¥–º—ñ–Ω–∏—Ç–∏ {label}", callback_data=f"cancel_{rec}"))
            if edit_message_id:
                bot.edit_message_text(text, chat_id, edit_message_id, reply_markup=kb)
            else:
                bot.send_message(chat_id, text, reply_markup=kb)
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –≤ send_my_records: {e}")
            bot.send_message(chat_id, "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∑–∞–ø–∏—Å—ñ–≤.")

    @bot.message_handler(commands=['stats'])
    def stats(message):
        if message.chat.id != ADMIN_ID:
            return
        records = get_all_records()
        total = len(records)
        by_service = {}
        by_day = {}
        for k, v in records.items():
            parts = k.split('|')
            service = parts[0] if len(parts) > 0 else "unknown"
            if len(parts) >= 5:
                y, m, d = parts[2:5]
                date_key = f"{y}_{m}_{d}"
                by_day[date_key] = by_day.get(date_key, 0) + 1
            by_service[service] = by_service.get(service, 0) + 1
        text = f"üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total}\n"
        text += "\n".join([f"{s}: {c}" for s, c in by_service.items()])
        text += "\n\nüìÖ –ó–∞–ø–∏—Å–∏ –ø–æ –¥–Ω—è–º:\n"
        text += "\n".join([f"{d}: {c}" for d, c in by_day.items()])
        kb = types.InlineKeyboardMarkup()
        kb.add(types.InlineKeyboardButton('–ï–∫—Å–ø–æ—Ä—Ç CSV', callback_data='export_csv'))
        bot.send_message(message.chat.id, text, reply_markup=kb)

    @bot.message_handler(commands=['admin'])
    def admin(message):
        if message.chat.id != ADMIN_ID:
            bot.send_message(message.chat.id, '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.')
            return
        records = get_all_records()
        if not records:
            bot.send_message(message.chat.id, '–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.')
        else:
            text = "üìä –í—Å–µ –∑–∞–ø–∏—Å–∏:\n"
            for k, v in records.items():
                text += f"{k} ‚Äì {v['username']} ({v['id']}), –Ü–º'—è: {v['name']}\n"
            bot.send_message(message.chat.id, text)

    @bot.message_handler(commands=['today'])
    def today_records(message):
        if message.chat.id != ADMIN_ID:
            return
        today_keys = get_today_records()
        if not today_keys:
            bot.send_message(message.chat.id, '–ó–∞–ø–∏—Å—ñ–≤ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –Ω–µ–º–∞—î.')
            return
        text = "üìÖ –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ:\n"
        for key in today_keys:
            data = get_record(key)
            name = data['name'] if data and 'name' in data else ''
            uid = data['id'] if data and 'id' in data else ''
            text += f"{key} ‚Äì {name} ({uid})\n"
        bot.send_message(message.chat.id, text)

    @bot.message_handler(commands=['feedback'])
    def feedback_stats(message):
        if message.chat.id != ADMIN_ID:
            return
        # –ó–∞–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å sqlite3 –Ω–∞ –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ PostgreSQL
        # –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ —î —Ñ—É–Ω–∫—Ü—ñ—è get_feedback_stats() –≤ db.py, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —ó—ó.
        # –ù–∏–∂—á–µ –ø—Ä–∏–∫–ª–∞–¥-–∑–∞–≥–ª—É—à–∫–∞:
        avg, count, last = None, 0, None
        reviews = []
        avg_text = f"{avg:.1f}" if avg is not None else "–Ω–µ–º–∞—î –æ—Ü—ñ–Ω–æ–∫"
        text = f"‚≠êÔ∏è –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: {avg_text} ({count} –æ—Ç–∑—ã–≤–æ–≤)\n\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–∑—ã–≤—ã:\n"
        for review, rating in reviews:
            text += f"{rating}‚≠ê ‚Äî {review}\n"
        bot.send_message(message.chat.id, text)

    @bot.message_handler(commands=['addslot'])
    def add_slot(message):
        if message.chat.id != ADMIN_ID:
            return
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–ª–æ—Ç–∞ (service|master|YYYY|MM|DD|HH:MM):")
        bot.register_next_step_handler(message, process_add_slot)

    def process_add_slot(message):
        key = message.text.strip()
        save_record(key, {"id": "manual", "username": "admin", "service": key.split('|')[0]})
        bot.send_message(message.chat.id, f"–°–ª–æ—Ç {key} –¥–æ–±–∞–≤–ª–µ–Ω.")

    @bot.message_handler(commands=['help'])
    def help_cmd(message):
        text = (
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥–∏:\n"
            "/start, /menu ‚Äî –ó–∞–ø—É—Å–∫ –º–µ–Ω—é\n"
            "/my ‚Äî –ú–æ–∏ –∑–∞–ø–∏—Å–∏\n"
            "/stats ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø–∏—Å–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n"
            "/admin ‚Äî –≠–∫—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n"
            "/today ‚Äî –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n"
            "/feedback ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≥—É–∫—ñ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n"
            "/addslot ‚Äî –î–æ–±–∞–≤–∏—Ç–∏ —Å–ª–æ—Ç –≤—Ä—É—á–Ω—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞)\n"
            "/help ‚Äî –ü–æ–∫–∞–∑–∞—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è\n"
            "\n"
            "–û–ø–∏—Å:\n"
            "‚Ä¢ –ó–∞–ø–∏—Å –Ω–∞ –ø–æ—Å–ª—É–≥–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é\n"
            "‚Ä¢ –ß–µ—Ä–≥–∞, —è–∫—â–æ —Å–ª–æ—Ç –∑–∞–π–Ω—è—Ç–∏–π\n"
            "‚Ä¢ –ù–∞–≥–∞–¥—É–≤–∞–Ω–Ω—è —Ç–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è\n"
            "‚Ä¢ –ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫ –ø—ñ—Å–ª—è –≤—ñ–∑–∏—Ç—É\n"
        )
        bot.send_message(message.chat.id, text)

    @bot.callback_query_handler(func=lambda call: True)
    def handle_query(call):
        chat_id = call.message.chat.id
        data = call.data

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if chat_id not in user_states and (
            data.startswith('master_') or
            data.startswith('day_') or
            data.startswith('time_') or
            data == 'confirm_yes' or
            data == 'confirm_no' or
            data == 'choose_master' or
            data == 'choose_day'
        ):
            user_states.pop(chat_id, None)  # –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            bot.answer_callback_query(call.id, "–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–µ–Ω–∞ –∞–±–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞. –ü–æ—á–Ω—ñ—Ç—å —Å–ø–æ—á–∞—Ç–∫—É —á–µ—Ä–µ–∑ /start.", show_alert=True)
            return

        if data == 'export_csv':
            records = get_all_records()
            output = io.StringIO()
            writer = csv.writer(output)
            writer.writerow(['Key', 'User ID', 'Username', 'Service', 'Name'])
            for k, v in records.items():
                writer.writerow([k, v['id'], v['username'], v['service'], v['name']])
            output.seek(0)
            bot.send_document(chat_id, ('records.csv', output.getvalue().encode('utf-8')))
            bot.answer_callback_query(call.id)
            return

        if data.startswith("cancel_"):
            rec = data[len("cancel_"):]
            # –ó–∞–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å sqlite3 –Ω–∞ get_record
            record = get_record(rec)
            # –ê–¥–º—ñ–Ω –º–æ–∂–µ —Å–∫–∞—Å—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π –∑–∞–ø–∏—Å
            if record and (record['id'] == str(call.from_user.id) or chat_id == ADMIN_ID):
                delete_record(rec)
                notify_waitlist(bot, rec)
                bot.answer_callback_query(call.id, "–ó–∞–ø–∏—Å –≤—ñ–¥–º—ñ–Ω–µ–Ω–æ ‚ùå")
                send_my_records(chat_id, call.from_user.id, edit_message_id=call.message.message_id)
            else:
                bot.answer_callback_query(call.id, "–¶–µ–π –∑–∞–ø–∏—Å —É–∂–µ –Ω–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏ –∞–±–æ –Ω–µ –≤–∞—à.", show_alert=True)
            return

        if data in config['services']:
            user_states[chat_id] = {'service': data}
            bot.edit_message_text('–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞:', chat_id, call.message.message_id,
                                  reply_markup=masters_kb(data))

        elif data.startswith('master_'):
            master_id = data.split('_')[1]
            user_states[chat_id]['master'] = master_id
            now = datetime.datetime.now()
            user_states[chat_id]['year'] = now.year
            user_states[chat_id]['month'] = now.month
            bot.edit_message_text(config['messages'].get('choose_day', '–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å:'), chat_id, call.message.message_id,
                                  reply_markup=days_kb(now.year, now.month))

        elif data.startswith('month_'):
            y, m = map(int, data.split('_')[1:])
            user_states[chat_id]['year'], user_states[chat_id]['month'] = y, m
            bot.edit_message_text(config['messages'].get('choose_day', '–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å:'), chat_id, call.message.message_id,
                                  reply_markup=days_kb(y, m))

        elif data.startswith('showdays_'):
            y, m = map(int, data.split('_')[1:])
            user_states[chat_id]['year'], user_states[chat_id]['month'] = y, m
            bot.edit_message_text(config['messages'].get('choose_day', '–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å:'), chat_id, call.message.message_id,
                                  reply_markup=days_kb(y, m))

        elif data.startswith('day_'):
            day = int(data.split('_')[1])
            service = user_states[chat_id]['service']
            if user_service_count(chat_id, service) >= 1:
                bot.answer_callback_query(call.id, '–í–∏ –≤–∂–µ –º–∞—î—Ç–µ –∑–∞–ø–∏—Å –Ω–∞ —Ü—é –ø–æ—Å–ª—É–≥—É! –í—ñ–¥–º—ñ–Ω—ñ—Ç—å –ø–æ–ø–µ—Ä–µ–¥–Ω—é.', show_alert=True)
                return
            user_states[chat_id]['day'] = day
            master = user_states[chat_id]['master']
            bot.edit_message_text(config['messages'].get('choose_time', '–û–±–µ—Ä—ñ—Ç—å —á–∞—Å:'), chat_id, call.message.message_id,
                                  reply_markup=time_kb(service, user_states[chat_id]['year'], user_states[chat_id]['month'], day, free_only=True))

        elif data.startswith('time_'):
            tm = data.split('_')[1][:2] + ':' + data.split('_')[1][2:]
            user_states[chat_id]['time'] = tm
            s = user_states[chat_id]['service']
            master = user_states[chat_id]['master']
            d = user_states[chat_id]['day']
            y = user_states[chat_id]['year']
            m = user_states[chat_id]['month']
            name = f"@{call.from_user.username}" if call.from_user.username else ""
            user_states[chat_id]['name'] = name
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –º–∞—Å—Ç–µ—Ä–∞
            if master == "admin":
                master_name = "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä"
            else:
                master_info = config['services'][s]['masters'].get(master)
                master_name = master_info['name'] if master_info and 'name' in master_info else master
            text = config['messages']['preview'].format(
                service=escape_md(s.capitalize()), day=d, month_name=escape_md(MONTH_NAMES[m]), year=y, time=escape_md(tm)
            ) + f"\n–ú–∞–π—Å—Ç–µ—Ä: {escape_md(master_name)}\n–Ü–º'—è: {escape_md(name)}"
            bot.edit_message_text(text, chat_id, call.message.message_id, parse_mode='Markdown', reply_markup=confirm_kb())

        elif data == 'confirm_yes':
            s = user_states[chat_id]['service']
            master = user_states[chat_id]['master']
            d = user_states[chat_id]['day']
            tm = user_states[chat_id]['time']
            y = user_states[chat_id]['year']
            m = user_states[chat_id]['month']
            name = user_states[chat_id].get('name', '')
            key = f"{s}|{master}|{y:04d}|{m:02d}|{d:02d}|{tm}"
            username = f"@{call.from_user.username}" if call.from_user.username else "–ë–µ–∑ username"
            data = {"id": str(chat_id), "username": username, "service": s, "name": name}
            save_record(key, data)
            bot.edit_message_text(config['messages'].get('recorded', '‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ!'), chat_id, call.message.message_id)
            # –ü–æ–ª—É—á–∏—Ç—å ID –º–∞—Å—Ç–µ—Ä–∞ –∏–∑ config –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ADMIN_ID
            if master == "admin":
                master_id = ADMIN_ID
            else:
                master_info = config['services'][s]['masters'].get(master)
                master_id = master_info['id'] if master_info and 'id' in master_info else ADMIN_ID
            bot.send_message(master_id, f"–ù–æ–≤–∞ –∑–∞–ø–∏—Å: {key} –≤—ñ–¥ {username}")
            user_states.pop(chat_id, None)

        elif data == 'confirm_no':
            bot.edit_message_text(config['messages'].get('canceled', '‚ùå –ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞.'), chat_id, call.message.message_id)
            user_states.pop(chat_id, None)

        elif data == 'choose_service':
            bot.edit_message_text(config['messages'].get('welcome', '–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É:'), chat_id, call.message.message_id,
                                  reply_markup=services_kb())

        elif data == 'choose_master':
            s = user_states[chat_id]['service']
            bot.edit_message_text('–û–±–µ—Ä—ñ—Ç—å –º–∞–π—Å—Ç—Ä–∞:', chat_id, call.message.message_id,
                                  reply_markup=masters_kb(s))

        elif data == 'choose_day':
            s = user_states[chat_id]['service']
            y = user_states[chat_id]['year']
            m = user_states[chat_id]['month']
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤—ã–±–æ—Ä–∞ –¥–Ω—è
            try:
                bot.edit_message_text(
                    config['messages'].get('choose_day', '–û–±–µ—Ä—ñ—Ç—å –¥–µ–Ω—å:'),
                    chat_id,
                    call.message.message_id,
                    reply_markup=days_kb(y, m)
                )
            except ApiTelegramException as e:
                if "message is not modified" in str(e):
                    pass
                else:
                    raise

        bot.answer_callback_query(call.id)

def escape_md(text):
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown
    if not text:
        return ""
    for ch in r'_*[]()~`>#+-=|{}.!':
        text = text.replace(ch, '\\' + ch)
    return text